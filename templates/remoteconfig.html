<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet" href="../static/remoteaccess.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <title>Remote Config</title>
</head>
<body>
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="content">
        <div class="content-header">
            <h2><i class="fa-solid fa-laptop-code" style="color: #1E90FF;"></i> Remote Config</h2>  
            <div>
                <button id="apply-button" class="apply-button">Apply</button>
            </div>
        </div>

        <div class="content-body">
            <label for="command-select"><strong>Select Command:</strong></label>
            <select id="command-select" multiple="multiple" style="width: 500px;">
                <option value="show running-config">Show Running Config</option>
                <option value="show vlan brief">Show VLAN Brief</option>
                <option value="show ip interface brief">Show IP Interface Brief</option>
            </select>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>Model</th>
                            <th>Serial No./Token</th>
                            <th>Hostname</th>
                            <th>IP</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for switch in switches %}
                        <tr>
                            <td><input type="checkbox" class="device-checkbox"></td>
                            <td>{{ switch.model }}</td>
                            <td>{{ switch.serial }}</td>
                            <td>{{ switch.hostname }}</td>
                            <td>{{ switch.ip }}</td>
                            <td>{{ switch.status }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            // Apply Select2 to the dropdown
            $('#command-select').select2({
                placeholder: "Select Commands", 
                allowClear: true
            });

            // ฟังก์ชัน Select All Checkbox
            $('#select-all').on('change', function() {
                const isChecked = $(this).is(':checked');
                $('.device-checkbox').prop('checked', isChecked);
            });

            // ตรวจสอบสถานะของ checkbox แต่ละตัวเพื่ออัปเดต Select All
            $('.device-checkbox').on('change', function() {
                const total = $('.device-checkbox').length;
                const checked = $('.device-checkbox:checked').length;

                $('#select-all').prop('checked', total === checked);
            });

            // เมื่อกด Apply
            $('#apply-button').on('click', function() {
                // ดึงคำสั่งจาก Select
                const selectedCommands = $('#command-select').val();

                // ดึงอุปกรณ์ที่ถูกเลือกจากตาราง
                const selectedDevices = [];
                $('input.device-checkbox:checked').each(function() {
                    const row = $(this).closest('tr');
                    selectedDevices.push({
                        ip: row.find('td').eq(4).text(), // IP
                        hostname: row.find('td').eq(3).text() // Hostname
                    });
                });

                // ตรวจสอบเงื่อนไข
                if (selectedCommands.length === 0 || selectedDevices.length === 0) {
                    alert("Please select at least one command and one device.");
                    return;
                }

                // ส่งข้อมูลไปยัง Backend
                $.ajax({
                    url: '/api/remote_send_command_save',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        devices: selectedDevices,
                        commands: selectedCommands
                    }),
                    success: function(response) {
                        alert("Command executed successfully and output saved.");
                    },
                    error: function(xhr) {
                        alert("Error: " + xhr.responseJSON.error);
                    }
                });
            });
        });
    </script>
    
</body>
</html>
